name: Floyd Safe Ops - Pre-Merge Impact Simulation

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - '**.{ts,tsx,js,jsx,go,rs,py}'
      - 'src/**'
      - 'server/**'
      - 'lib/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  impact-simulation:
    name: Simulate Impact of Changes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git operations

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          if [ -f "package.json" ]; then
            npm ci
          fi

      - name: Start Floyd MCP servers
        run: |
          echo "Starting Floyd MCP servers for CI/CD..."
          # Start FloydDesktopWeb in background
          cd /Volumes/Storage/FloydDesktopWeb-v2
          npm run dev &
          sleep 5

      - name: Wait for MCP servers
        run: |
          echo "Waiting for MCP servers to be ready..."
          timeout 60 bash -c 'until curl -s http://localhost:3001/api/mcp/status | jq -e .initialized; do sleep 2; done'
          echo "MCP servers ready"

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v42
        with:
          files: |
            **.{ts,tsx,js,jsx,go,rs,py}
          separator: ','

      - name: Prepare impact simulation payload
        id: payload
        run: |
          # Convert changed files to impact simulation format
          CHANGED_FILES="${{ steps.changed-files.outputs.all_changed_files }}"

          # Create operations array
          OPERATIONS="["
          FIRST=true
          IFS=',' read -ra FILES <<< "$CHANGED_FILES"
          for file in "${FILES[@]}"; do
            if [ -f "$file" ]; then
              if [ "$FIRST" = true ]; then
                FIRST=false
              else
                OPERATIONS+=","
              fi
              OPERATIONS+="{\"type\":\"edit\",\"path\":\"$file\"}"
            fi
          done
          OPERATIONS+="]"

          # Save to file for next step
          echo "$OPERATIONS" > /tmp/impact_operations.json
          cat /tmp/impact_operations.json

      - name: Run Impact Simulation
        id: impact
        run: |
          echo "Running impact simulation via Floyd-Safe-Ops..."

          # Call impact_simulate tool via FloydDesktopWeb
          RESPONSE=$(curl -s -X POST http://localhost:3001/api/tools/execute \
            -H "Content-Type: application/json" \
            -d "{
              \"name\": \"floyd-safe-ops-server:impact_simulate\",
              \"args\": {
                \"operations\": $(cat /tmp/impact_operations.json),
                \"resolvedProjectPath\": \"${{ github.workspace }}\",
                \"checkImports\": true,
                \"checkTests\": true,
                \"checkGit\": true
              }
            }")

          echo "Response: $RESPONSE"

          # Check if simulation was successful
          if echo "$RESPONSE" | jq -e '.success'; then
            # Extract impact results
            IMPACT=$(echo "$RESPONSE" | jq -r '.result')

            # Save impact report
            echo "$IMPACT" > /tmp/impact_report.json

            # Get statistics
            AFFECTED_FILES=$(echo "$IMPACT" | jq -r '.affected_files // 0')
            IMPACTED_IMPORTS=$(echo "$IMPACT" | jq -r '.impacted_imports // 0')
            AFFECTED_TESTS=$(echo "$IMPACT" | jq -r '.affected_tests // 0')
            HIGH_IMPACT=$(echo "$IMPACT" | jq -r '.high_impact // false')

            echo "## Impact Simulation Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Affected Files:** $AFFECTED_FILES" >> $GITHUB_STEP_SUMMARY
            echo "- **Impacted Imports:** $IMPACTED_IMPORTS" >> $GITHUB_STEP_SUMMARY
            echo "- **Affected Tests:** $AFFECTED_TESTS" >> $GITHUB_STEP_SUMMARY
            echo "- **High Impact:** $HIGH_IMPACT" >> $GITHUB_STEP_SUMMARY

            # Check for high impact
            if [ "$HIGH_IMPACT" = "true" ]; then
              echo "⚠️ WARNING: High impact changes detected!" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Consider:" >> $GITHUB_STEP_SUMMARY
              echo "- Breaking changes into smaller PRs" >> $GITHUB_STEP_SUMMARY
              echo "- Adding additional tests" >> $GITHUB_STEP_SUMMARY
              echo "- Reviewing with team" >> $GITHUB_STEP_SUMMARY

              # Add PR comment
              gh pr comment ${{ github.event.number }} --body "⚠️ **High Impact Changes Detected**

              This PR affects $AFFECTED_FILES files and $IMPACTED_IMPORTS imports.

              Please review carefully and consider:
              - Breaking into smaller PRs
              - Adding test coverage
              - Manual review with team

              [View Impact Report](#)" || true
            fi

            # Set outputs
            echo "affected_files=$AFFECTED_FILES" >> $GITHUB_OUTPUT
            echo "high_impact=$HIGH_IMPACT" >> $GITHUB_OUTPUT

            # Upload impact report as artifact
            echo "AFFECTED_FILES=$AFFECTED_FILES" >> $GITHUB_ENV
            echo "HIGH_IMPACT=$HIGH_IMPACT" >> $GITHUB_ENV

          else
            echo "Impact simulation failed!"
            echo "$RESPONSE" | jq -r '.error // .message' >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Upload impact report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: impact-simulation-report
          path: /tmp/impact_report.json
          retention-days: 30

      - name: Comment on PR
        if: steps.impact.outputs.high_impact == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `⚠️ **High Impact Changes Detected**

              This PR affects ${{ steps.impact.outputs.affected_files }} files.

              Please review carefully and consider:
              - Breaking into smaller PRs
              - Adding test coverage
              - Manual review with team`
            })

      - name: Require review for high impact
        if: steps.impact.outputs.high_impact == 'true'
        uses: mshick/add-pr-branch@v2
        with:
          branch: 'review-required'
          force: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
